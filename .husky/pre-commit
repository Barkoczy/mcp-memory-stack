#!/usr/bin/env sh

echo "🔍 Running pre-commit checks..."

# Run lint-staged for staged files
echo "📝 Checking code style and formatting..."
npx lint-staged

# Check if there are any linting errors
if [ $? -ne 0 ]; then
  echo "❌ Linting failed. Please fix the issues and try again."
  exit 1
fi

# Enhanced secrets detection
echo "🔒 Checking for potential secrets..."

# More precise secret detection - avoid false positives from code
# Look for actual secret patterns, not just keywords in code
staged_files=$(git diff --cached --name-only --diff-filter=AM 2>/dev/null || true)
if [ -n "$staged_files" ]; then
  # Check for actual credential assignments with real values (not test patterns)
  # Exclude test files and config files with obvious test values
  secret_files=$(echo "$staged_files" | grep -v -E '\.(test|spec)\.(js|ts)$|\.env\.test$|\.env\.example$' || true)
  if [ -n "$secret_files" ]; then
    # Look for actual secrets: long strings assigned to credential-like variables
    # Exclude obvious test/example values
    echo "$secret_files" | xargs grep -H -n -E "(password|secret|token|api_key)\s*[:=]\s*['\"][^'\"]{20,}" 2>/dev/null | \
    grep -v -E "(test_|example_|demo_|mock_|fake_|placeholder|your_|<|>|\$\{)" && {
      echo "⚠️  Warning: Potential secrets detected in staged files!"
      echo "Please review and remove any sensitive information before committing."
      exit 1
    } || true
  fi
fi

# Check for private keys and high-confidence patterns
staged_files=$(git diff --cached --name-only --diff-filter=AM 2>/dev/null || true)
if [ -n "$staged_files" ]; then
  # Check for actual private keys and tokens (not variable names)
  echo "$staged_files" | xargs grep -l -E "(BEGIN [A-Z]+ PRIVATE KEY|AKIA[0-9A-Z]{16}|[A-Za-z0-9+/]{40,})" 2>/dev/null && {
    echo "🚨 Critical: Private keys or tokens detected!"
    echo "These appear to be actual secrets. Please remove them immediately."
    exit 1
  } || true
fi

# Check for TODO/FIXME comments in staged files
echo "📋 Checking for TODO/FIXME comments..."
staged_files=$(git diff --cached --name-only --diff-filter=AM | grep -E '\.(js|ts|jsx|tsx)$' || true)
if [ -n "$staged_files" ]; then
  todo_count=$(echo "$staged_files" | xargs grep -c -i -E "(TODO|FIXME|XXX|HACK)" 2>/dev/null | awk -F: '{sum += $2} END {print sum+0}')
  if [ "$todo_count" -gt 0 ]; then
    echo "📝 Found $todo_count TODO/FIXME comments in staged files"
    echo "Consider addressing these before committing to production"
  fi
fi

echo "✅ Pre-commit checks passed!"