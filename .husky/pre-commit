#!/usr/bin/env sh

echo "🔍 Running pre-commit checks..."

# Run lint-staged for staged files
echo "📝 Checking code style and formatting..."
npx lint-staged

# Check if there are any linting errors
if [ $? -ne 0 ]; then
  echo "❌ Linting failed. Please fix the issues and try again."
  exit 1
fi

# Enhanced secrets detection
echo "🔒 Checking for potential secrets..."

# Basic pattern matching for immediate detection
git diff --cached --name-only | xargs grep -l -i -E "(password|secret|key|token|api_key|private_key|credential)" 2>/dev/null && {
  echo "⚠️  Warning: Potential secrets detected in staged files!"
  echo "Please review and remove any sensitive information before committing."
  echo "If these are legitimate file contents, you can bypass this check with --no-verify"
  exit 1
} || true

# Additional security patterns
staged_files=$(git diff --cached --name-only --diff-filter=AM 2>/dev/null || true)
if [ -n "$staged_files" ]; then
  # Check for common secret patterns
  secret_patterns="(BEGIN RSA PRIVATE KEY|BEGIN PRIVATE KEY|-----BEGIN|aws_access_key_id|aws_secret_access_key|GITHUB_TOKEN|SLACK_TOKEN)"
  echo "$staged_files" | xargs grep -l -E "$secret_patterns" 2>/dev/null && {
    echo "🚨 Critical: High-confidence secrets detected!"
    echo "These patterns indicate actual secrets. Please remove them immediately."
    exit 1
  } || true
fi

# Check for TODO/FIXME comments in staged files
echo "📋 Checking for TODO/FIXME comments..."
staged_files=$(git diff --cached --name-only --diff-filter=AM | grep -E '\.(js|ts|jsx|tsx)$' || true)
if [ -n "$staged_files" ]; then
  todo_count=$(echo "$staged_files" | xargs grep -c -i -E "(TODO|FIXME|XXX|HACK)" 2>/dev/null | awk -F: '{sum += $2} END {print sum+0}')
  if [ "$todo_count" -gt 0 ]; then
    echo "📝 Found $todo_count TODO/FIXME comments in staged files"
    echo "Consider addressing these before committing to production"
  fi
fi

echo "✅ Pre-commit checks passed!"